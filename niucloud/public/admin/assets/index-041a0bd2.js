import{N as T,d as pe,r as m,a5 as ie,Y as G,h as p,c as i,e,w as l,P as I,a as n,i as v,t as o,B as C,F as M,Q as R,u as r,q as s,a6 as $,s as Q,R as D,a8 as ce,a9 as X,G as Y,_ as de,aj as _e,S as fe,E as ge,ag as ve,ah as me,X as he,ai as xe,a1 as ye,p as ke,g as we}from"./index-ae2d9b78.js";/* empty css                  *//* empty css                   */import{T as Ce,_ as Te}from"./vue-web-terminal-6de9e244.js";/* empty css                *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 */import be from"./index-a2492aae.js";import{_ as Be}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                   */function Ee(c=""){return T.get(c?`upgrade/${c}`:"upgrade")}function Ue(){return T.get("upgrade/task")}function Se(c=""){return T.post(c?`upgrade/${c}`:"upgrade")}function Ve(){return T.post("upgrade/execute",{})}function Ie(c=""){return T.get(c?`upgrade/check/${c}`:"upgrade/check")}function Me(){return T.post("upgrade/clear")}const $e=c=>(ke("data-v-f4e8a0b3"),c=c(),we(),c),Ne={key:0,class:"h-[60vh] flex flex-col"},Fe={class:"text-lg"},Le={class:"font-bold"},Re={class:"font-bold"},De={key:0,class:"mt-[10px]"},He=$e(()=>n("a",{class:"text-primary",href:"https://www.niucloud.com",target:"_blank"},"niucloud-admin官网",-1)),je={class:"font-bold text-lg"},qe={key:0,class:"mt-[5px]"},Ae=["innerHTML"],Ke={class:"flex justify-end"},Pe={key:0,class:"h-[60vh] flex flex-col"},Ge={key:0,class:"bg-[#fff] my-3"},Qe={class:"pt-[20px] pl-[20px]"},Xe={class:"px-[20px] pt-[10px] text-[14px] el-table"},Ye={key:0},ze={key:1},Je={key:0},Oe={key:1},We={class:"h-[60vh]"},Ze={class:"h-[60vh] flex flex-col"},et={class:"flex-1 h-0"},tt={class:"flex justify-end"},lt=["innerHTML"],at={class:"flex justify-end"},st=pe({__name:"index",emits:["complete"],setup(c,{expose:z,emit:J}){const d=m(!1),_=m(null),f=m(null),h=m("content"),b=m(null),k=m(!1),B=m(null),H=m(null),E=m(!1);let N=[];const S=()=>{Ue().then(({data:a})=>{if(a){if(!d.value){W();return}if(f.value||(B.value.execute("clear"),B.value.execute("开始升级")),a.log.forEach(t=>{N.includes(t)||(B.value.pushMessage({content:`正在执行：${t}`}),N.push(t))}),a.error){f.value=a,D({message:"升级失败",type:"error"}),B.value.pushMessage({content:a.error,class:"error"});return}if(a.step=="upgradeComplete"){h.value="complete",U&&U.close(),J("complete");return}f.value=a,O()}}).catch()};S();const O=()=>{Ve().then(()=>{S()}).catch()};let U=null;const W=()=>{U=ce.success({title:s("warning"),dangerouslyUseHTMLString:!0,message:X("div",{},[s("upgrade.upgradingTips"),X("span",{class:"text-primary cursor-pointer",onClick:Z},[s("upgrade.clickView")])]),duration:0,showClose:!1})},Z=()=>{d.value=!0,h.value="upgrade",S(),U&&U.close()},ee=async()=>{var t,x;if(k.value)return;k.value=!0;const a=((t=_.value)==null?void 0:t.app.app_key)!="niucloud-admin"?(x=_.value)==null?void 0:x.app.app_key:"";await Ie(a).then(async({data:w})=>{w.is_pass?await Se(a).then(()=>{S()}).catch(()=>{k.value=!1}):b.value=w}).catch(),k.value&&(h.value="upgrade")},te=(a="")=>{f.value?(D({message:"已有正在执行中的升级任务",type:"error"}),d.value=!0):Ee(a).then(({data:t})=>{if(_.value=t,!t.version_list.length){D({message:"已经是最新版本了",type:"error"});return}Y.get("upgradeTipsLock")?d.value=!0:E.value=!0}).catch()};let F=null;const j=new Ce,le=(a,t,x,w,y)=>{if(t=="开始升级"){x(j);const g=ae(["/","——","\\","|"]);F=setInterval(()=>{j.flush("> "+g.next().value)},150)}},ae=a=>{var t=0;return{next(){return t+1==a.length&&(t=0),{value:a[t++]}}}},se=a=>{h.value=="upgrade"&&f.value&&!f.value.error?de.confirm(s("upgrade.showDialogCloseTips"),s("warning"),{confirmButtonText:s("confirm"),cancelButtonText:s("cancel"),type:"warning"}).then(()=>{a()}).catch(()=>{}):a()};ie(()=>d.value,()=>{d.value||ne()});const ne=()=>{h.value="content",k.value=!1,f.value=null,N=[],F&&clearInterval(F),Me().then(()=>{}).catch()},oe=()=>{var a;d.value=!1,(a=H.value)==null||a.open()},q=(a=!1)=>{a&&Y.set({key:"upgradeTipsLock",data:a}),E.value=!1,!a&&(d.value=!0)};return z({open:te}),(a,t)=>{const x=_e,w=fe,y=ge,g=ve,L=me,A=G("Select"),V=he,K=G("CloseBold"),ue=xe,P=ye;return p(),i(M,null,[e(P,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=u=>d.value=u),title:r(s)("upgrade.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":se},{default:l(()=>[I(n("div",null,[_.value?(p(),i("div",Ne,[n("div",Fe,[v(" 本次升级将从"),n("span",Le,o(_.value.version),1),v("升级到"),n("span",Re,o(_.value.upgrade_version),1),v("版本 ")]),_.value.upgrade_version!=_.value.last_version?(p(),i("div",De,[e(x,{type:"info","show-icon":""},{title:l(()=>[v(" 当前最新版本为"+o(_.value.last_version)+"，您的服务已于"+o(_.value.expire_time)+"到期。如需升级到最新版可在",1),He,v("购买相关服务后再进行升级 ")]),_:1})])):C("",!0),e(w,{class:"flex-1 h-0 mt-[20px]"},{default:l(()=>[(p(!0),i(M,null,R(_.value.version_list,(u,re)=>(p(),i("div",{class:"mt-[20px]",key:re},[n("div",je,o(u.version_no),1),u.release_time?(p(),i("div",qe,o(u.release_time),1)):C("",!0),u.upgrade_log?(p(),i("div",{key:1,class:"mt-[10px] p-[10px] rounded bg-[#f4f4f5] whitespace-pre",innerHTML:u.upgrade_log},null,8,Ae)):C("",!0)]))),128))]),_:1})])):C("",!0),n("div",Ke,[e(y,{type:"primary",onClick:ee,loading:k.value},{default:l(()=>[v(o(r(s)("upgrade.upgradeButton")),1)]),_:1},8,["loading"])])],512),[[$,h.value=="content"]]),I(n("div",null,[b.value&&!f.value?(p(),i("div",Pe,[e(w,null,{default:l(()=>[b.value.dir?(p(),i("div",Ge,[n("p",Qe,o(r(s)("upgrade.dirPermission")),1),n("div",Xe,[e(L,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(g,{span:12},{default:l(()=>[n("span",null,o(r(s)("upgrade.path")),1)]),_:1}),e(g,{span:6},{default:l(()=>[n("span",null,o(r(s)("upgrade.demand")),1)]),_:1}),e(g,{span:6},{default:l(()=>[n("span",null,o(r(s)("status")),1)]),_:1})]),_:1}),(p(!0),i(M,null,R(b.value.dir.is_readable,u=>(p(),Q(L,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(g,{span:12},{default:l(()=>[n("span",null,o(u.dir),1)]),_:2},1024),e(g,{span:6},{default:l(()=>[n("span",null,o(r(s)("upgrade.readable")),1)]),_:1}),e(g,{span:6},{default:l(()=>[u.status?(p(),i("span",Ye,[e(V,{color:"green"},{default:l(()=>[e(A)]),_:1})])):(p(),i("span",ze,[e(V,{color:"red"},{default:l(()=>[e(K)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(p(!0),i(M,null,R(b.value.dir.is_write,u=>(p(),Q(L,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(g,{span:12},{default:l(()=>[n("span",null,o(u.dir),1)]),_:2},1024),e(g,{span:6},{default:l(()=>[n("span",null,o(r(s)("upgrade.write")),1)]),_:1}),e(g,{span:6},{default:l(()=>[u.status?(p(),i("span",Je,[e(V,{color:"green"},{default:l(()=>[e(A)]),_:1})])):(p(),i("span",Oe,[e(V,{color:"red"},{default:l(()=>[e(K)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):C("",!0)]),_:1})])):C("",!0),I(n("div",We,[e(r(Te),{ref_key:"terminalRef",ref:B,context:f.value?f.value.upgrade.app_key:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:le},null,8,["context"])],512),[[$,f.value]])],512),[[$,h.value=="upgrade"]]),I(n("div",null,[n("div",Ze,[n("div",et,[e(ue,{icon:"success",title:r(s)("upgrade.upgradeSuccess")},null,8,["title"]),e(x,{title:r(s)("upgrade.upgradeCompleteTips"),type:"error",closable:!1},null,8,["title"])]),n("div",tt,[e(y,{type:"default",onClick:t[0]||(t[0]=u=>d.value=!1)},{default:l(()=>[v(o(r(s)("upgrade.localBuild")),1)]),_:1}),e(y,{type:"primary",onClick:oe},{default:l(()=>[v(o(r(s)("upgrade.cloudBuild")),1)]),_:1})])])],512),[[$,h.value=="complete"]])]),_:1},8,["modelValue","title"]),e(P,{modelValue:E.value,"onUpdate:modelValue":t[5]||(t[5]=u=>E.value=u),title:r(s)("warning"),width:"500px",draggable:""},{footer:l(()=>[n("div",at,[e(y,{onClick:t[2]||(t[2]=u=>q(!0)),type:"primary"},{default:l(()=>[v(o(r(s)("upgrade.knownToKnow")),1)]),_:1}),e(y,{onClick:t[3]||(t[3]=u=>q()),type:"primary",plain:""},{default:l(()=>[v(o(r(s)("upgrade.upgradeButton")),1)]),_:1}),e(y,{onClick:t[4]||(t[4]=u=>E.value=!1)},{default:l(()=>[v(o(r(s)("cancel")),1)]),_:1})])]),default:l(()=>[n("span",{innerHTML:r(s)("upgrade.upgradeTips")},null,8,lt)]),_:1},8,["modelValue","title"]),e(be,{ref_key:"cloudBuildRef",ref:H},null,512)],64)}}});const mt=Be(st,[["__scopeId","data-v-f4e8a0b3"]]);export{mt as default};
