import{a1 as T,d as ae,r as x,s as se,a8 as K,h as n,I as q,w as l,y as L,c as u,e,a as t,t as o,u as i,N as a,F as R,G as A,B as V,z as M,ai as ne,aj as J,aa as oe,aq as ue,ar as ce,a7 as re,as as ie,at as de,ad as pe,a4 as xe,i as S,a2 as Z,au as ke,E as ye,p as be,g as we}from"./index-022827e1.js";/* empty css                   */import{T as _e,_ as fe}from"./vue-web-terminal-290a9892.js";/* empty css                *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                 *//* empty css                   */import{_ as ve}from"./_plugin-vue_export-helper-c27b6911.js";function Ce(g=""){return T.get(g?`upgrade/${g}`:"upgrade")}function Be(){return T.get("upgrade/task")}function Te(g=""){return T.post(g?`upgrade/${g}`:"upgrade")}function Ee(){return T.post("upgrade/execute",{},{timeout:0})}function $e(g=""){return T.get(g?`upgrade/check/${g}`:"upgrade/check")}function Ie(){return T.post("upgrade/clear")}function Ue(){return T.post("niucloud/build",{},{timeout:0})}function Se(){return T.get("niucloud/build")}function Ve(){return T.get("niucloud/build/log")}function Fe(){return T.post("niucloud/build/clear")}function Le(){return T.get("niucloud/build/check")}const Me={class:"h-[60vh]"},Ne={key:0,class:"h-[60vh] flex flex-col"},Re={key:0,class:"bg-[#fff] my-3"},De={class:"pt-[20px] pl-[20px]"},He={class:"px-[20px] pt-[10px] text-[14px] el-table"},je={key:0},qe={key:1},Ae={key:0},Pe={key:1},ze={class:"h-[60vh]"},Ge={class:"h-[60vh] flex flex-col"},Ke={class:"flex-1 h-0"},Je=ae({__name:"index",emits:["complete"],setup(g,{expose:O,emit:ee}){const r=x(!1),d=x(null),p=x("build"),h=x(null),w=x(!1),k=x(null);let C=[];(()=>{Se().then(({data:_})=>{_&&(d.value=_,r.value||W())}).catch()})();const $=()=>{Ve().then(_=>{if(!_.data){r.value&&C.length&&(p.value="complete",k.value.execute("clear")),I&&I.close(),d.value=null;return}const f=_.data.data??[];let v="";f[0]&&f[0].length&&r.value&&(C.length==0&&(k.value.execute("clear"),k.value.execute("开始编译")),f[0].forEach(y=>{C.includes(y.action)||(k.value.pushMessage({content:`正在执行：${y.action}`}),C.push(y.action),y.code==0&&(v=y.msg,k.value.pushMessage({content:y.msg,class:"error"})))})),!v&&setTimeout(()=>{$()},2e3)}).catch()};let I=null;const W=()=>{I=ne.success({title:a("warning"),dangerouslyUseHTMLString:!0,message:J("div",{},[a("cloudbuild.executingTips"),J("span",{class:"text-primary cursor-pointer",onClick:F},[a("cloudbuild.clickView")])]),duration:0,showClose:!1})},F=()=>{r.value=!0,p.value="build",$()},X=async()=>{if(r.value=!0,w.value=!0,p.value="build",d.value){w.value=!1,$();return}Le().then(async({data:_})=>{_.is_pass?Ue().then(({data:f})=>{w.value=!1,d.value=f,$()}).catch(()=>{r.value=!1}):(w.value=!1,h.value=_)}).catch(()=>{r.value=!1})};let D=null;const P=new _e,Y=(_,f,v,y,j)=>{if(f=="开始编译"){v(P);const s=H(["/","——","\\","|"]);D=setInterval(()=>{P.flush("> "+s.next().value)},150)}},H=_=>{var f=0;return{next(){return f+1==_.length&&(f=0),{value:_[f++]}}}},z=_=>{p.value=="cloudbuild"&&d.value?oe.confirm(a("cloudbuild.showDialogCloseTips"),a("warning"),{confirmButtonText:a("confirm"),cancelButtonText:a("cancel"),type:"warning"}).then(()=>{_()}).catch(()=>{}):_()};return se(()=>r.value,()=>{r.value||(p.value="build",C=[],D&&clearInterval(D),Fe())}),O({open:X,cloudBuildTask:d}),(_,f)=>{const v=ue,y=ce,j=K("Select"),s=re,c=K("CloseBold"),E=ie,U=de,N=pe,b=xe;return n(),q(N,{modelValue:r.value,"onUpdate:modelValue":f[0]||(f[0]=B=>r.value=B),title:i(a)("cloudbuild.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":z},{default:l(()=>[L((n(),u("div",Me,[h.value&&!d.value?(n(),u("div",Ne,[e(E,null,{default:l(()=>[h.value.dir?(n(),u("div",Re,[t("p",De,o(i(a)("cloudbuild.dirPermission")),1),t("div",He,[e(y,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(i(a)("cloudbuild.path")),1)]),_:1}),e(v,{span:6},{default:l(()=>[t("span",null,o(i(a)("cloudbuild.demand")),1)]),_:1}),e(v,{span:6},{default:l(()=>[t("span",null,o(i(a)("status")),1)]),_:1})]),_:1}),(n(!0),u(R,null,A(h.value.dir.is_readable,B=>(n(),q(y,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(B.dir),1)]),_:2},1024),e(v,{span:6},{default:l(()=>[t("span",null,o(i(a)("cloudbuild.readable")),1)]),_:1}),e(v,{span:6},{default:l(()=>[B.status?(n(),u("span",je,[e(s,{color:"green"},{default:l(()=>[e(j)]),_:1})])):(n(),u("span",qe,[e(s,{color:"red"},{default:l(()=>[e(c)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(n(!0),u(R,null,A(h.value.dir.is_write,B=>(n(),q(y,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(v,{span:12},{default:l(()=>[t("span",null,o(B.dir),1)]),_:2},1024),e(v,{span:6},{default:l(()=>[t("span",null,o(i(a)("cloudbuild.write")),1)]),_:1}),e(v,{span:6},{default:l(()=>[B.status?(n(),u("span",Ae,[e(s,{color:"green"},{default:l(()=>[e(j)]),_:1})])):(n(),u("span",Pe,[e(s,{color:"red"},{default:l(()=>[e(c)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):V("",!0)]),_:1})])):V("",!0),L(t("div",ze,[e(i(fe),{ref_key:"terminalRef",ref:k,context:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:Y},null,512)],512),[[M,d.value]])])),[[M,p.value=="build"],[b,w.value]]),L(t("div",null,[t("div",Ge,[t("div",Ke,[e(U,{icon:"success",title:i(a)("cloudbuild.cloudbuildSuccess")},null,8,["title"])])])],512),[[M,p.value=="complete"]])]),_:1},8,["modelValue","title"])}}});const Oe=ve(Je,[["__scopeId","data-v-5a176c78"]]),Qe=g=>(be("data-v-a12e3956"),g=g(),we(),g),We={key:0,class:"h-[60vh] flex flex-col"},Xe={class:"text-lg"},Ye={class:"font-bold"},Ze={class:"font-bold"},el={key:0,class:"mt-[10px]"},ll=Qe(()=>t("a",{class:"text-primary",href:"https://www.niucloud.com",target:"_blank"},"niucloud-admin官网",-1)),tl={class:"font-bold text-lg"},al={key:0,class:"mt-[5px]"},sl=["innerHTML"],nl={class:"flex justify-end"},ol={key:0,class:"h-[60vh] flex flex-col"},ul={key:0,class:"bg-[#fff] my-3"},cl={class:"pt-[20px] pl-[20px]"},rl={class:"px-[20px] pt-[10px] text-[14px] el-table"},il={key:0},dl={key:1},pl={key:0},_l={key:1},fl={class:"h-[60vh]"},vl={class:"h-[60vh] flex flex-col"},gl={class:"flex-1 h-0"},hl={class:"flex justify-end"},ml=ae({__name:"index",emits:["complete"],setup(g,{expose:O,emit:ee}){const r=x(!1),d=x(null),p=x(null),h=x("content"),w=x(null),k=x(!1),C=x(null),Q=x(null);let $=[];const I=()=>{Be().then(({data:s})=>{if(s){if(!r.value){X();return}if(p.value||(C.value.execute("clear"),C.value.execute("开始升级")),s.log.forEach(c=>{$.includes(c)||(C.value.pushMessage({content:`正在执行：${c}`}),$.push(c))}),s.error){p.value=s,Z({message:"升级失败",type:"error"}),C.value.pushMessage({content:s.error,class:"error"});return}if(s.step=="upgradeComplete"){h.value="complete",F&&F.close(),ee("complete");return}p.value=s,W()}}).catch()};I();const W=()=>{Ee().then(()=>{I()}).catch()};let F=null;const X=()=>{F=ne.success({title:a("warning"),dangerouslyUseHTMLString:!0,message:J("div",{},[a("upgrade.upgradingTips"),J("span",{class:"text-primary cursor-pointer",onClick:D},[a("upgrade.clickView")])]),duration:0,showClose:!1})},D=()=>{r.value=!0,h.value="upgrade",I(),F&&F.close()},P=async()=>{var c,E;if(k.value)return;k.value=!0;const s=((c=d.value)==null?void 0:c.app.app_key)!="niucloud-admin"?(E=d.value)==null?void 0:E.app.app_key:"";await $e(s).then(async({data:U})=>{U.is_pass?await Te(s).then(()=>{I()}).catch(()=>{k.value=!1}):w.value=U}).catch(),k.value&&(h.value="upgrade")},Y=(s="")=>{if(p.value){Z({message:"已有正在执行中的升级任务",type:"error"}),r.value=!0;return}Ce(s).then(({data:c})=>{if(d.value=c,!c.version_list.length){Z({message:"已经是最新版本了",type:"error"});return}r.value=!0}).catch()};let H=null;const z=new _e,_=(s,c,E,U,N)=>{if(c=="开始升级"){E(z);const b=f(["/","——","\\","|"]);H=setInterval(()=>{z.flush("> "+b.next().value)},150)}},f=s=>{var c=0;return{next(){return c+1==s.length&&(c=0),{value:s[c++]}}}},v=s=>{h.value=="upgrade"&&p.value&&!p.value.error?oe.confirm(a("upgrade.showDialogCloseTips"),a("warning"),{confirmButtonText:a("confirm"),cancelButtonText:a("cancel"),type:"warning"}).then(()=>{s()}).catch(()=>{}):s()};se(()=>r.value,()=>{r.value||y()});const y=()=>{h.value="content",k.value=!1,p.value=null,$=[],H&&clearInterval(H),Ie().then(()=>{}).catch()},j=()=>{var s;r.value=!1,(s=Q.value)==null||s.open()};return O({open:Y}),(s,c)=>{const E=ke,U=ie,N=ye,b=ue,B=ce,le=K("Select"),G=re,te=K("CloseBold"),ge=de,he=pe;return n(),u(R,null,[e(he,{modelValue:r.value,"onUpdate:modelValue":c[1]||(c[1]=m=>r.value=m),title:i(a)("upgrade.title"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"before-close":v},{default:l(()=>[L(t("div",null,[d.value?(n(),u("div",We,[t("div",Xe,[S(" 本次升级将从"),t("span",Ye,o(d.value.version),1),S("升级到"),t("span",Ze,o(d.value.upgrade_version),1),S("版本 ")]),d.value.upgrade_version!=d.value.last_version?(n(),u("div",el,[e(E,{type:"info","show-icon":""},{title:l(()=>[S(" 当前最新版本为"+o(d.value.last_version)+"，您的服务已于"+o(d.value.expire_time)+"到期。如需升级到最新版可在",1),ll,S("购买相关服务后再进行升级 ")]),_:1})])):V("",!0),e(U,{class:"flex-1 h-0 mt-[20px]"},{default:l(()=>[(n(!0),u(R,null,A(d.value.version_list,(m,me)=>(n(),u("div",{class:"mt-[20px]",key:me},[t("div",tl,o(m.version_no),1),m.release_time?(n(),u("div",al,o(m.release_time),1)):V("",!0),m.upgrade_log?(n(),u("div",{key:1,class:"mt-[10px] p-[10px] rounded bg-[#f4f4f5] whitespace-pre",innerHTML:m.upgrade_log},null,8,sl)):V("",!0)]))),128))]),_:1})])):V("",!0),t("div",nl,[e(N,{type:"primary",onClick:P,loading:k.value},{default:l(()=>[S(o(i(a)("upgrade.upgradeButton")),1)]),_:1},8,["loading"])])],512),[[M,h.value=="content"]]),L(t("div",null,[w.value&&!p.value?(n(),u("div",ol,[e(U,null,{default:l(()=>[w.value.dir?(n(),u("div",ul,[t("p",cl,o(i(a)("upgrade.dirPermission")),1),t("div",rl,[e(B,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:l(()=>[e(b,{span:12},{default:l(()=>[t("span",null,o(i(a)("upgrade.path")),1)]),_:1}),e(b,{span:6},{default:l(()=>[t("span",null,o(i(a)("upgrade.demand")),1)]),_:1}),e(b,{span:6},{default:l(()=>[t("span",null,o(i(a)("status")),1)]),_:1})]),_:1}),(n(!0),u(R,null,A(w.value.dir.is_readable,m=>(n(),q(B,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(b,{span:12},{default:l(()=>[t("span",null,o(m.dir),1)]),_:2},1024),e(b,{span:6},{default:l(()=>[t("span",null,o(i(a)("upgrade.readable")),1)]),_:1}),e(b,{span:6},{default:l(()=>[m.status?(n(),u("span",il,[e(G,{color:"green"},{default:l(()=>[e(le)]),_:1})])):(n(),u("span",dl,[e(G,{color:"red"},{default:l(()=>[e(te)]),_:1})]))]),_:2},1024)]),_:2},1024))),256)),(n(!0),u(R,null,A(w.value.dir.is_write,m=>(n(),q(B,{class:"pb-[10px] items pl-[15px]"},{default:l(()=>[e(b,{span:12},{default:l(()=>[t("span",null,o(m.dir),1)]),_:2},1024),e(b,{span:6},{default:l(()=>[t("span",null,o(i(a)("upgrade.write")),1)]),_:1}),e(b,{span:6},{default:l(()=>[m.status?(n(),u("span",pl,[e(G,{color:"green"},{default:l(()=>[e(le)]),_:1})])):(n(),u("span",_l,[e(G,{color:"red"},{default:l(()=>[e(te)]),_:1})]))]),_:2},1024)]),_:2},1024))),256))])])):V("",!0)]),_:1})])):V("",!0),L(t("div",fl,[e(i(fe),{ref_key:"terminalRef",ref:C,context:p.value?p.value.upgrade.app_key:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:_},null,8,["context"])],512),[[M,p.value]])],512),[[M,h.value=="upgrade"]]),L(t("div",null,[t("div",vl,[t("div",gl,[e(ge,{icon:"success",title:i(a)("upgrade.upgradeSuccess")},null,8,["title"]),e(E,{title:i(a)("upgrade.upgradeCompleteTips"),type:"error",closable:!1},null,8,["title"])]),t("div",hl,[e(N,{type:"default",onClick:c[0]||(c[0]=m=>r.value=!1)},{default:l(()=>[S(o(i(a)("upgrade.localBuild")),1)]),_:1}),e(N,{type:"primary",onClick:j},{default:l(()=>[S(o(i(a)("upgrade.cloudBuild")),1)]),_:1})])])],512),[[M,h.value=="complete"]])]),_:1},8,["modelValue","title"]),e(Oe,{ref_key:"cloudBuildRef",ref:Q},null,512)],64)}}});const Il=ve(ml,[["__scopeId","data-v-a12e3956"]]);export{Oe as C,Il as U};
